var M={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150,navPrefetchDelay:65,navCacheTTL:30000,navCacheMaxEntries:20},jJ=["click","input","change","submit","keydown","keyup","focus","blur"];function $J(J,Q){if(J&&J.startsWith("ws"))return J;let Y=Q.protocol==="https:"?"wss:":"ws:",Z=J||M.wsPath;return`${Y}//${Q.host}${Z}`}function WJ(J){return{prevent:J.dataset.lPrevent==="true",stop:J.dataset.lStop==="true",shouldDebounce:J.dataset.lDebounce!==void 0,debounce:parseInt(J.dataset.lDebounce||"")||M.defaultDebounce}}function XJ(J){let Q={},Y=J.target;if(Y.value!==void 0)Q.value=Y.value;if(Y.type==="checkbox"||Y.type==="radio")Q.checked=Y.checked;if(J.key!==void 0)Q.key=J.key;return Q}function qJ(){let J=document.activeElement,Q=J,Y=!!J&&(J.tagName==="INPUT"||J.tagName==="TEXTAREA");return{element:J,isInput:Y,selectionStart:Q?.selectionStart??null,selectionEnd:Q?.selectionEnd??null,handlerId:J?.dataset?.lInput||J?.dataset?.lChange||J?.id}}function zJ(J,Q){if(!Q.isInput||!Q.handlerId)return;let Y=J.querySelector(`[data-l-input="${Q.handlerId}"], [data-l-change="${Q.handlerId}"], #${Q.handlerId}`);if(!Y)return;if(Y.focus(),typeof Q.selectionStart==="number"&&typeof Q.selectionEnd==="number")try{Y.setSelectionRange(Q.selectionStart,Q.selectionEnd)}catch{}}function GJ(J){if(J.nodeType!==1)return null;let Q=J;return Q.dataset?.lInput||Q.dataset?.lClick||Q.dataset?.lChange||Q.dataset?.lSubmit||Q.id||null}class y{socket=null;connected=!1;reconnectAttempts=0;nextId=0;handlers=new Map;reconnectCallbacks=[];pendingMessages=[];wsUrlOverride;constructor(J){this.wsUrlOverride=J??null,this.connect()}allocateId(){return`c${this.nextId++}`}register(J,Q){this.handlers.set(J,Q)}unregister(J){this.handlers.delete(J),this.send({type:"leave",id:J})}send(J){if(this.connected&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(J));else this.pendingMessages.push(J)}onReconnect(J){return this.reconnectCallbacks.push(J),()=>{let Q=this.reconnectCallbacks.indexOf(J);if(Q!==-1)this.reconnectCallbacks.splice(Q,1)}}destroy(){for(let J of this.handlers.keys())this.send({type:"leave",id:J});if(this.handlers.clear(),this.reconnectCallbacks=[],this.socket)this.socket.onclose=null,this.socket.close(),this.socket=null;this.connected=!1}connect(){let J=$J(this.wsUrlOverride,window.location);this.socket=new WebSocket(J),this.socket.onopen=()=>{if(console.log("[Loom] Socket connected"),this.connected=!0,this.reconnectAttempts=0,this.flushPending(),this.reconnectCallbacks.length>0)this.reconnectCallbacks.forEach((Q)=>Q())},this.socket.onmessage=(Q)=>{this.routeMessage(JSON.parse(Q.data))},this.socket.onclose=()=>{console.log("[Loom] Socket disconnected"),this.connected=!1,this.attemptReconnect()},this.socket.onerror=(Q)=>{console.error("[Loom] Socket error:",Q)}}flushPending(){while(this.pendingMessages.length>0){let J=this.pendingMessages.shift();this.socket.send(JSON.stringify(J))}}routeMessage(J){if(J.type==="redirect"){if(window.Loom?.nav)window.Loom.nav.navigate(J.url);else window.location.href=J.url;return}if(J.id){let Q=this.handlers.get(J.id);if(Q)Q(J)}}attemptReconnect(){if(this.reconnectAttempts>=M.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let J=M.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${J}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},J)}}var BJ=11;function xJ(J,Q){var Y=Q.attributes,Z,j,$,q,B;if(Q.nodeType===BJ||J.nodeType===BJ)return;for(var H=Y.length-1;H>=0;H--)if(Z=Y[H],j=Z.name,$=Z.namespaceURI,q=Z.value,$){if(j=Z.localName||j,B=J.getAttributeNS($,j),B!==q){if(Z.prefix==="xmlns")j=Z.name;J.setAttributeNS($,j,q)}}else if(B=J.getAttribute(j),B!==q)J.setAttribute(j,q);var _=J.attributes;for(var R=_.length-1;R>=0;R--)if(Z=_[R],j=Z.name,$=Z.namespaceURI,$){if(j=Z.localName||j,!Q.hasAttributeNS($,j))J.removeAttributeNS($,j)}else if(!Q.hasAttribute(j))J.removeAttribute(j)}var E,bJ="http://www.w3.org/1999/xhtml",A=typeof document>"u"?void 0:document,kJ=!!A&&"content"in A.createElement("template"),FJ=!!A&&A.createRange&&"createContextualFragment"in A.createRange();function TJ(J){var Q=A.createElement("template");return Q.innerHTML=J,Q.content.childNodes[0]}function vJ(J){if(!E)E=A.createRange(),E.selectNode(A.body);var Q=E.createContextualFragment(J);return Q.childNodes[0]}function CJ(J){var Q=A.createElement("body");return Q.innerHTML=J,Q.childNodes[0]}function gJ(J){if(J=J.trim(),kJ)return TJ(J);else if(FJ)return vJ(J);return CJ(J)}function f(J,Q){var Y=J.nodeName,Z=Q.nodeName,j,$;if(Y===Z)return!0;if(j=Y.charCodeAt(0),$=Z.charCodeAt(0),j<=90&&$>=97)return Y===Z.toUpperCase();else if($<=90&&j>=97)return Z===Y.toUpperCase();else return!1}function yJ(J,Q){return!Q||Q===bJ?A.createElement(J):A.createElementNS(Q,J)}function EJ(J,Q){var Y=J.firstChild;while(Y){var Z=Y.nextSibling;Q.appendChild(Y),Y=Z}return Q}function d(J,Q,Y){if(J[Y]!==Q[Y])if(J[Y]=Q[Y],J[Y])J.setAttribute(Y,"");else J.removeAttribute(Y)}var HJ={OPTION:function(J,Q){var Y=J.parentNode;if(Y){var Z=Y.nodeName.toUpperCase();if(Z==="OPTGROUP")Y=Y.parentNode,Z=Y&&Y.nodeName.toUpperCase();if(Z==="SELECT"&&!Y.hasAttribute("multiple")){if(J.hasAttribute("selected")&&!Q.selected)J.setAttribute("selected","selected"),J.removeAttribute("selected");Y.selectedIndex=-1}}d(J,Q,"selected")},INPUT:function(J,Q){if(d(J,Q,"checked"),d(J,Q,"disabled"),J.value!==Q.value)J.value=Q.value;if(!Q.hasAttribute("value"))J.removeAttribute("value")},TEXTAREA:function(J,Q){var Y=Q.value;if(J.value!==Y)J.value=Y;var Z=J.firstChild;if(Z){var j=Z.nodeValue;if(j==Y||!Y&&j==J.placeholder)return;Z.nodeValue=Y}},SELECT:function(J,Q){if(!Q.hasAttribute("multiple")){var Y=-1,Z=0,j=J.firstChild,$,q;while(j)if(q=j.nodeName&&j.nodeName.toUpperCase(),q==="OPTGROUP"){if($=j,j=$.firstChild,!j)j=$.nextSibling,$=null}else{if(q==="OPTION"){if(j.hasAttribute("selected")){Y=Z;break}Z++}if(j=j.nextSibling,!j&&$)j=$.nextSibling,$=null}J.selectedIndex=Y}}},w=1,PJ=11,VJ=3,_J=8;function O(){}function fJ(J){if(J)return J.getAttribute&&J.getAttribute("id")||J.id}function uJ(J){return function(Y,Z,j){if(!j)j={};if(typeof Z==="string")if(Y.nodeName==="#document"||Y.nodeName==="HTML"){var $=Z;Z=A.createElement("html"),Z.innerHTML=$}else if(Y.nodeName==="BODY"){var q=Z;Z=A.createElement("html"),Z.innerHTML=q;var B=Z.querySelector("body");if(B)Z=B}else Z=gJ(Z);else if(Z.nodeType===PJ)Z=Z.firstElementChild;var H=j.getNodeKey||fJ,_=j.onBeforeNodeAdded||O,R=j.onNodeAdded||O,KJ=j.onBeforeElUpdated||O,IJ=j.onElUpdated||O,OJ=j.onBeforeNodeDiscarded||O,x=j.onNodeDiscarded||O,RJ=j.onBeforeElChildrenUpdated||O,LJ=j.skipFromChildren||O,JJ=j.addChild||function(W,X){return W.appendChild(X)},s=j.childrenOnly===!0,L=Object.create(null),b=[];function k(W){b.push(W)}function QJ(W,X){if(W.nodeType===w){var P=W.firstChild;while(P){var z=void 0;if(X&&(z=H(P)))k(z);else if(x(P),P.firstChild)QJ(P,X);P=P.nextSibling}}}function F(W,X,P){if(OJ(W)===!1)return;if(X)X.removeChild(W);x(W),QJ(W,P)}function m(W){if(W.nodeType===w||W.nodeType===PJ){var X=W.firstChild;while(X){var P=H(X);if(P)L[P]=X;m(X),X=X.nextSibling}}}m(Y);function a(W){R(W);var X=W.firstChild;while(X){var P=X.nextSibling,z=H(X);if(z){var G=L[z];if(G&&f(X,G))X.parentNode.replaceChild(G,X),T(G,X);else a(X)}else a(X);X=P}}function UJ(W,X,P){while(X){var z=X.nextSibling;if(P=H(X))k(P);else F(X,W,!0);X=z}}function T(W,X,P){var z=H(X);if(z)delete L[z];if(!P){var G=KJ(W,X);if(G===!1)return;else if(G instanceof HTMLElement)W=G,m(W);if(J(W,X),IJ(W),RJ(W,X)===!1)return}if(W.nodeName!=="TEXTAREA")SJ(W,X);else HJ.TEXTAREA(W,X)}function SJ(W,X){var P=LJ(W,X),z=X.firstChild,G=W.firstChild,U,D,S,C,K;J:while(z){C=z.nextSibling,U=H(z);while(!P&&G){if(S=G.nextSibling,z.isSameNode&&z.isSameNode(G)){z=C,G=S;continue J}D=H(G);var g=G.nodeType,I=void 0;if(g===z.nodeType){if(g===w){if(U){if(U!==D)if(K=L[U])if(S===K)I=!1;else{if(W.insertBefore(K,G),D)k(D);else F(G,W,!0);G=K,D=H(G)}else I=!1}else if(D)I=!1;if(I=I!==!1&&f(G,z),I)T(G,z)}else if(g===VJ||g==_J){if(I=!0,G.nodeValue!==z.nodeValue)G.nodeValue=z.nodeValue}}if(I){z=C,G=S;continue J}if(D)k(D);else F(G,W,!0);G=S}if(U&&(K=L[U])&&f(K,z)){if(!P)JJ(W,K);T(K,z)}else{var l=_(z);if(l!==!1){if(l)z=l;if(z.actualize)z=z.actualize(W.ownerDocument||A);JJ(W,z),a(z)}}z=C,G=S}UJ(W,G,D);var YJ=HJ[W.nodeName];if(YJ)YJ(W,X)}var V=Y,v=V.nodeType,ZJ=Z.nodeType;if(!s){if(v===w)if(ZJ===w){if(!f(Y,Z))x(Y),V=EJ(Y,yJ(Z.nodeName,Z.namespaceURI))}else V=Z;else if(v===VJ||v===_J)if(ZJ===v){if(V.nodeValue!==Z.nodeValue)V.nodeValue=Z.nodeValue;return V}else V=Z}if(V===Z)x(Y);else{if(Z.isSameNode&&Z.isSameNode(V))return;if(T(V,Z,s),b)for(var i=0,wJ=b.length;i<wJ;i++){var n=L[b[i]];if(n)F(n,n.parentNode,!1)}}if(!s&&V!==Y&&Y.parentNode){if(V.actualize)V=V.actualize(Y.ownerDocument||A);Y.parentNode.replaceChild(V,Y)}return V}}var hJ=uJ(xJ),AJ=hJ;function u(J,Q){let Y="";for(let Z=0;Z<J.length;Z++)if(Y+=J[Z],Z<Q.length)Y+=pJ(Q[Z]);return Y}function pJ(J){if(typeof J==="string")return J;if(Array.isArray(J))return J.map((Q)=>u(Q.s,Q.d)).join("");if(J&&typeof J==="object"&&"s"in J&&"d"in J)return u(J.s,J.d);return""}function MJ(J,Q){if(!Q||!J)return;for(let Y of Object.keys(Q)){let Z=parseInt(Y,10),j=Q[Y];if(typeof j==="string")J[Z]=j;else if(Array.isArray(j))J[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)J[Z]=j;else if("d"in j){let $=J[Z];if($&&typeof $==="object"){if(Array.isArray($))DJ($,j.d);else if("d"in $)r($,j.d)}}}}}function r(J,Q){if(!Q||!J.d)return;for(let Y of Object.keys(Q)){let Z=parseInt(Y,10),j=Q[Y];if(typeof j==="string")J.d[Z]=j;else if(Array.isArray(j))J.d[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)J.d[Z]=j;else if("d"in j){let $=J.d[Z];if($&&typeof $==="object"){if(Array.isArray($))DJ($,j.d);else if("d"in $)r($,j.d)}}}}}function DJ(J,Q){if(!Q)return;for(let Y of Object.keys(Q)){let Z=parseInt(Y,10),j=Q[Y];if(j&&typeof j==="object"){if("s"in j&&"d"in j)J[Z]=j;else if("d"in j){if(J[Z]&&typeof J[Z]==="object"&&"d"in J[Z])r(J[Z],j.d)}}}}var t=new WeakMap;class h{container;module;token;id;loomSocket;initialized=!1;pendingEvents=[];statics=null;dynamics=null;loadingElements=new Map;unsubReconnect;constructor(J,Q){this.container=J,this.module=J.dataset.lLive,this.token=J.dataset.lToken,this.loomSocket=Q,this.id=Q.allocateId(),Q.register(this.id,(Y)=>this.handleMessage(Y)),this.unsubReconnect=Q.onReconnect(()=>this.rejoin()),this.sendJoin(),this.attachEventListeners(),this.hideLoadingIndicators()}sendJoin(){this.loomSocket.send({type:"join",id:this.id,module:this.module,token:this.token}),this.initialized=!0;while(this.pendingEvents.length>0)this.sendEvent(this.pendingEvents.shift())}rejoin(){this.initialized=!1,this.statics=null,this.dynamics=null,this.sendJoin()}sendEvent(J){if(this.initialized)this.loomSocket.send(J);else this.pendingEvents.push(J)}handleMessage(J){switch(J.type){case"trees":this.statics=J.s,this.dynamics=J.d,this.clearLoadingStates();break;case"patch":if(this.clearLoadingStates(),this.statics&&this.dynamics){MJ(this.dynamics,J.d);let Q=u(this.statics,this.dynamics);this.applyPatch(Q)}break;case"error":this.clearLoadingStates(),console.error("[Loom] Server error:",J.error);break;default:console.warn("[Loom] Unknown message type:",J.type)}}applyPatch(J){let Q=qJ(),Y=document.createElement("div");Y.innerHTML=J,AJ(this.container,Y,{childrenOnly:!0,getNodeKey:GJ,onBeforeElUpdated:(Z,j)=>{if(Z!==this.container&&Z.hasAttribute("data-l-live"))return!1;if(Z===Q.element&&Q.isInput)j.value=Z.value;return!0}}),this.attachEventListeners(),this.hideLoadingIndicators(),zJ(this.container,Q)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((Q)=>{if(Q.closest("[data-l-live]")!==this.container)return;this.attachElementListeners(Q)})}attachElementListeners(J){if(J._loomAttached)return;J._loomAttached=!0;let Q=WJ(J);jJ.forEach((Y)=>{let Z=J.dataset[`l${Y.charAt(0).toUpperCase()+Y.slice(1)}`];if(!Z)return;J.addEventListener(Y,(j)=>{this.handleEvent(j,Y,Z,Q,J)})})}handleEvent(J,Q,Y,Z,j){if(Z.prevent)J.preventDefault();if(Z.stop)J.stopPropagation();let $={type:"event",id:this.id,handler:Y,event:Q,special_vars:XJ(J)};if(Z.shouldDebounce)this.debouncedSend(j,$,Z.debounce);else{if(Q==="click"||Q==="submit")this.applyLoadingState(j);this.sendEvent($)}}applyLoadingState(J){let Q=J.hasAttribute("disabled");if(J.classList.add("l-loading"),!J.hasAttribute("l-no-disable"))J.setAttribute("disabled","");let Y=J.getAttribute("l-loading-text"),Z=null;if(Y!==null)Z=J.textContent,J.textContent=Y;let{shownIndicators:j,hiddenSiblings:$}=Y===null?this.toggleLoadingChildren(J):{shownIndicators:[],hiddenSiblings:[]},q=[],B=J.id;if(B)this.container.querySelectorAll(`[l-loading="${B}"], [data-l-loading="${B}"]`).forEach((H)=>{let _=H;_.classList.add("l-loading");let R=this.toggleLoadingChildren(_);q.push({element:_,...R})});this.loadingElements.set(J,{originalText:Z,wasDisabled:Q,shownIndicators:j,hiddenSiblings:$,remoteTargets:q})}toggleLoadingChildren(J){let Q=[],Y=[];for(let Z of Array.from(J.children))if(this.isLoadingIndicator(Z))Z.style.display="",Q.push(Z);if(Q.length>0){for(let Z of Array.from(J.children))if(!this.isLoadingIndicator(Z))Y.push({el:Z,originalDisplay:Z.style.display}),Z.style.display="none"}return{shownIndicators:Q,hiddenSiblings:Y}}isLoadingIndicator(J){return J.getAttribute("l-loading")===""||J.getAttribute("data-l-loading")===""}clearLoadingStates(){this.loadingElements.forEach((J,Q)=>{if(Q.classList.remove("l-loading"),!J.wasDisabled)Q.removeAttribute("disabled");if(J.originalText!==null)Q.textContent=J.originalText;this.reverseChildToggle(J),J.remoteTargets.forEach((Y)=>{Y.element.classList.remove("l-loading"),this.reverseChildToggle(Y)})}),this.loadingElements.clear()}reverseChildToggle(J){J.shownIndicators.forEach((Q)=>{Q.style.display="none"}),J.hiddenSiblings.forEach(({el:Q,originalDisplay:Y})=>{Q.style.display=Y})}hideLoadingIndicators(){this.container.querySelectorAll('[l-loading=""], [data-l-loading=""]').forEach((J)=>{J.style.display="none"})}debouncedSend(J,Q,Y){clearTimeout(t.get(J)),t.set(J,setTimeout(()=>{t.delete(J),this.sendEvent(Q)},Y))}destroy(){this.unsubReconnect(),this.loomSocket.unregister(this.id),this.initialized=!1}}class p{destroyLive;initLive;cache=new Map;scrollPositions=new Map;navCounter=0;currentNavId;prefetchTimer=null;prefetchController=null;inflightFetches=new Map;navigationController=null;enabled=!1;boundHandleClick;boundHandleMouseOver;boundHandleMouseOut;boundHandlePopState;boundHandleSubmit;constructor(J,Q){this.destroyLive=J,this.initLive=Q,this.currentNavId=this.nextNavId(),this.boundHandleClick=this.handleClick.bind(this),this.boundHandleMouseOver=this.handleMouseOver.bind(this),this.boundHandleMouseOut=this.handleMouseOut.bind(this),this.boundHandlePopState=this.handlePopState.bind(this),this.boundHandleSubmit=this.handleSubmit.bind(this)}enable(){if(this.enabled)return;this.enabled=!0,history.replaceState({loomNavId:this.currentNavId,url:location.href},"",location.href),document.addEventListener("click",this.boundHandleClick),document.addEventListener("mouseover",this.boundHandleMouseOver),document.addEventListener("mouseout",this.boundHandleMouseOut),document.addEventListener("submit",this.boundHandleSubmit),window.addEventListener("popstate",this.boundHandlePopState)}disable(){if(!this.enabled)return;this.enabled=!1,document.removeEventListener("click",this.boundHandleClick),document.removeEventListener("mouseover",this.boundHandleMouseOver),document.removeEventListener("mouseout",this.boundHandleMouseOut),document.removeEventListener("submit",this.boundHandleSubmit),window.removeEventListener("popstate",this.boundHandlePopState),this.cancelPrefetch()}async navigate(J){await this.performNavigation(J,!1)}handleClick(J){if(J.button!==0)return;if(J.metaKey||J.ctrlKey||J.shiftKey||J.altKey)return;let Q=J.target.closest?.("a");if(!Q)return;if(!this.shouldInterceptLink(Q))return;J.preventDefault(),this.performNavigation(Q.href,!1)}shouldInterceptLink(J){if(J.closest("[data-l-no-nav], [l-no-nav]"))return!1;if(J.hasAttribute("download"))return!1;let Q=J.getAttribute("target");if(Q&&Q!=="_self")return!1;if(!J.getAttribute("href"))return!1;let Z=J.protocol;if(Z&&Z!=="http:"&&Z!=="https:")return!1;if(J.origin!==location.origin)return!1;if(J.pathname===location.pathname&&J.search===location.search&&J.hash!=="")return!1;return!0}handleSubmit(J){let Q=J.target;if(!this.shouldInterceptForm(Q))return;J.preventDefault();let Y=new URL(Q.action||location.href,location.origin),Z=new URLSearchParams(new FormData(Q));Y.search=Z.toString(),this.performNavigation(Y.href,!1)}shouldInterceptForm(J){if((J.method||"GET").toUpperCase()!=="GET")return!1;if(J.closest("[data-l-no-nav], [l-no-nav]"))return!1;let Y=J.getAttribute("target");if(Y&&Y!=="_self")return!1;if(J.enctype==="multipart/form-data")return!1;if((J.action?new URL(J.action,location.origin):new URL(location.href)).origin!==location.origin)return!1;return!0}handleMouseOver(J){let Q=J.target.closest?.("a");if(!Q||!this.shouldInterceptLink(Q))return;let Y=this.normalizeUrl(Q.href);if(this.cacheGet(Y))return;this.cancelPrefetch(),this.prefetchTimer=setTimeout(()=>{this.prefetchController=new AbortController;let Z=this.fetchPage(Y,this.prefetchController.signal);this.inflightFetches.set(Y,Z),Z.then((j)=>{if(this.inflightFetches.delete(Y),j)this.cacheSet(Y,j)},()=>{this.inflightFetches.delete(Y)})},M.navPrefetchDelay)}handleMouseOut(J){if(!J.target.closest?.("a"))return;this.cancelPrefetch()}cancelPrefetch(){if(this.prefetchTimer)clearTimeout(this.prefetchTimer),this.prefetchTimer=null;if(this.prefetchController)this.prefetchController.abort(),this.prefetchController=null}normalizeUrl(J){return new URL(J,location.origin).href}cacheGet(J){let Q=this.cache.get(J);if(!Q)return null;if(Date.now()-Q.timestamp>M.navCacheTTL)return this.cache.delete(J),null;return Q}cacheSet(J,Q){if(this.cache.size>=M.navCacheMaxEntries){let Y=this.cache.keys().next().value;this.cache.delete(Y)}this.cache.set(J,Q)}async fetchPage(J,Q){try{let Y=await fetch(J,{headers:{Accept:"text/html"},signal:Q});if(!Y.ok)return null;if(!(Y.headers.get("Content-Type")||"").includes("text/html"))return null;let j=await Y.text(),$=this.parsePage(j);if(Y.redirected)$.resolvedUrl=Y.url;return $}catch{return null}}parsePage(J){let Q=new DOMParser().parseFromString(J,"text/html"),Y=[];Q.querySelectorAll("head meta[name], head meta[property]").forEach(($)=>Y.push($.outerHTML));let Z=[];Q.querySelectorAll('head link[rel="stylesheet"]').forEach(($)=>Z.push($.outerHTML));let j=[];return Q.querySelectorAll("head style").forEach(($)=>j.push($.outerHTML)),{html:Q.body.innerHTML,title:Q.title,headMeta:Y,headLinks:Z,headStyles:j,timestamp:Date.now()}}async performNavigation(J,Q){if(this.navigationController)this.navigationController.abort();this.navigationController=new AbortController;let Y=this.navigationController.signal,Z=this.normalizeUrl(J),j=new CustomEvent("loom:before-navigate",{cancelable:!0,detail:{url:Z,isPopState:Q}});if(!document.dispatchEvent(j))return;let $=this.cacheGet(Z);if(!$){let B=this.inflightFetches.get(Z);if(B)$=await B;else $=await this.fetchPage(Z,Y)}if(Y.aborted)return;if(!$){window.location.href=J;return}let q=$.resolvedUrl||Z;if(this.scrollPositions.set(this.currentNavId,{x:window.scrollX,y:window.scrollY}),this.destroyLive(),this.swapBody($.html),document.title=$.title,this.mergeHead($),this.reExecuteScripts(),!Q)this.currentNavId=this.nextNavId(),history.pushState({loomNavId:this.currentNavId,url:q},"",q);if(this.initLive(),Q){let H=history.state?.loomNavId;if(H){let _=this.scrollPositions.get(H);if(_)window.scrollTo(_.x,_.y)}}else{let B=new URL(q).hash;if(B){let H=document.querySelector(B);if(H)H.scrollIntoView();else window.scrollTo(0,0)}else window.scrollTo(0,0)}document.dispatchEvent(new CustomEvent("loom:after-navigate",{detail:{url:q,isPopState:Q}}))}mergeHead(J){let Q=new Set;for(let Z of J.headMeta){let j=document.createElement("div");j.innerHTML=Z;let $=j.firstChild;if(!$)continue;let q=$.getAttribute("name"),B=$.getAttribute("property");if(q)Q.add(`name:${q}`);else if(B)Q.add(`property:${B}`)}document.head.querySelectorAll("meta[name], meta[property]").forEach((Z)=>{let j=Z.getAttribute("name"),$=Z.getAttribute("property"),q=j?`name:${j}`:$?`property:${$}`:null;if(q&&!Q.has(q))Z.remove()});for(let Z of J.headMeta){let j=document.createElement("div");j.innerHTML=Z;let $=j.firstChild;if(!$)continue;let q=$.getAttribute("name"),B=$.getAttribute("property"),H=q?`meta[name="${q}"]`:B?`meta[property="${B}"]`:null;if(H){let _=document.head.querySelector(H);if(_)_.replaceWith($);else document.head.appendChild($)}}let Y=new Set;for(let Z of J.headLinks){let j=document.createElement("div");j.innerHTML=Z;let q=j.firstChild?.getAttribute("href");if(q)Y.add(q)}document.head.querySelectorAll('link[rel="stylesheet"]').forEach((Z)=>{let j=Z.getAttribute("href");if(j&&!Y.has(j))Z.remove()});for(let Z of J.headLinks){let j=document.createElement("div");j.innerHTML=Z;let $=j.firstChild;if(!$)continue;let q=$.getAttribute("href");if(q&&!document.head.querySelector(`link[href="${q}"]`))document.head.appendChild($)}document.head.querySelectorAll("style").forEach((Z)=>Z.remove());for(let Z of J.headStyles){let j=document.createElement("div");j.innerHTML=Z;let $=j.firstChild;if($)document.head.appendChild($)}}swapBody(J){let Q=document.createElement("template");Q.innerHTML=J,document.body.replaceChildren(...Q.content.childNodes)}reExecuteScripts(){document.body.querySelectorAll("script").forEach((J)=>{let Q=document.createElement("script");for(let Y of J.attributes)Q.setAttribute(Y.name,Y.value);Q.textContent=J.textContent,J.replaceWith(Q)})}handlePopState(J){let Q=J.state;if(!Q?.loomNavId){window.location.reload();return}this.currentNavId=Q.loomNavId,this.performNavigation(Q.url,!0)}nextNavId(){return`nav-${++this.navCounter}`}}var N=null,o=[],c=()=>{let J=document.querySelectorAll("[data-l-live]");if(J.length>0&&!N){let Q=J[0].dataset.lWs||null;N=new y(Q)}J.forEach((Q)=>{if(Q._loomInstance)return;let Y=new h(Q,N);Q._loomInstance=Y,o.push(Y)}),console.log(`[Loom] Initialized ${J.length} live component(s)`)},NJ=()=>{o.forEach((J)=>J.destroy()),o=[],document.querySelectorAll("[data-l-live]").forEach((J)=>{delete J._loomInstance})},e=new p(NJ,c);e.enable();c();window.Loom={init:c,reinit:c,LoomLive:h,LoomSocket:y,LoomNav:p,CONFIG:M,get socket(){return N},get nav(){return e},navigate:(J)=>e.navigate(J)};
