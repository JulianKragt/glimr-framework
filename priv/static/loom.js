var I={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150},Jz=["click","input","change","submit","keydown","keyup","focus","blur"];function Qz(z,J){if(z&&z.startsWith("ws"))return z;let Q=J.protocol==="https:"?"wss:":"ws:",Z=z||I.wsPath;return`${Q}//${J.host}${Z}`}function Zz(z){return{prevent:z.dataset.lPrevent==="true",stop:z.dataset.lStop==="true",shouldDebounce:z.dataset.lDebounce!==void 0,debounce:parseInt(z.dataset.lDebounce||"")||I.defaultDebounce}}function jz(z){let J={},Q=z.target;if(Q.value!==void 0)J.value=Q.value;if(Q.type==="checkbox"||Q.type==="radio")J.checked=Q.checked;if(z.key!==void 0)J.key=z.key;return J}function qz(){let z=document.activeElement,J=z,Q=!!z&&(z.tagName==="INPUT"||z.tagName==="TEXTAREA");return{element:z,isInput:Q,selectionStart:J?.selectionStart??null,selectionEnd:J?.selectionEnd??null,handlerId:z?.dataset?.lInput||z?.dataset?.lChange||z?.id}}function Yz(z,J){if(!J.isInput||!J.handlerId)return;let Q=z.querySelector(`[data-l-input="${J.handlerId}"], [data-l-change="${J.handlerId}"], #${J.handlerId}`);if(!Q)return;if(Q.focus(),typeof J.selectionStart==="number"&&typeof J.selectionEnd==="number")try{Q.setSelectionRange(J.selectionStart,J.selectionEnd)}catch{}}function Wz(z){if(z.nodeType!==1)return null;let J=z;return J.dataset?.lInput||J.dataset?.lClick||J.dataset?.lChange||J.dataset?.lSubmit||J.id||null}class y{socket=null;connected=!1;reconnectAttempts=0;nextId=0;handlers=new Map;reconnectCallbacks=[];pendingMessages=[];wsUrlOverride;constructor(z){this.wsUrlOverride=z??null,this.connect()}allocateId(){return`c${this.nextId++}`}register(z,J){this.handlers.set(z,J)}unregister(z){this.handlers.delete(z),this.send({type:"leave",id:z})}send(z){if(this.connected&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(z));else this.pendingMessages.push(z)}onReconnect(z){this.reconnectCallbacks.push(z)}destroy(){for(let z of this.handlers.keys())this.send({type:"leave",id:z});if(this.handlers.clear(),this.reconnectCallbacks=[],this.socket)this.socket.onclose=null,this.socket.close(),this.socket=null;this.connected=!1}connect(){let z=Qz(this.wsUrlOverride,window.location);this.socket=new WebSocket(z),this.socket.onopen=()=>{if(console.log("[Loom] Socket connected"),this.connected=!0,this.reconnectAttempts=0,this.flushPending(),this.reconnectCallbacks.length>0)this.reconnectCallbacks.forEach((J)=>J())},this.socket.onmessage=(J)=>{this.routeMessage(JSON.parse(J.data))},this.socket.onclose=()=>{console.log("[Loom] Socket disconnected"),this.connected=!1,this.attemptReconnect()},this.socket.onerror=(J)=>{console.error("[Loom] Socket error:",J)}}flushPending(){while(this.pendingMessages.length>0){let z=this.pendingMessages.shift();this.socket.send(JSON.stringify(z))}}routeMessage(z){if(z.type==="redirect"){window.location.href=z.url;return}if(z.id){let J=this.handlers.get(z.id);if(J)J(z)}}attemptReconnect(){if(this.reconnectAttempts>=I.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let z=I.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${z}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},z)}}var $z=11;function Oz(z,J){var Q=J.attributes,Z,j,W,B,M;if(J.nodeType===$z||z.nodeType===$z)return;for(var V=Q.length-1;V>=0;V--)if(Z=Q[V],j=Z.name,W=Z.namespaceURI,B=Z.value,W){if(j=Z.localName||j,M=z.getAttributeNS(W,j),M!==B){if(Z.prefix==="xmlns")j=Z.name;z.setAttributeNS(W,j,B)}}else if(M=z.getAttribute(j),M!==B)z.setAttribute(j,B);var A=z.attributes;for(var K=A.length-1;K>=0;K--)if(Z=A[K],j=Z.name,W=Z.namespaceURI,W){if(j=Z.localName||j,!J.hasAttributeNS(W,j))z.removeAttributeNS(W,j)}else if(!J.hasAttribute(j))z.removeAttribute(j)}var E,Rz="http://www.w3.org/1999/xhtml",G=typeof document>"u"?void 0:document,Sz=!!G&&"content"in G.createElement("template"),xz=!!G&&G.createRange&&"createContextualFragment"in G.createRange();function kz(z){var J=G.createElement("template");return J.innerHTML=z,J.content.childNodes[0]}function bz(z){if(!E)E=G.createRange(),E.selectNode(G.body);var J=E.createContextualFragment(z);return J.childNodes[0]}function Fz(z){var J=G.createElement("body");return J.innerHTML=z,J.childNodes[0]}function Tz(z){if(z=z.trim(),Sz)return kz(z);else if(xz)return bz(z);return Fz(z)}function h(z,J){var Q=z.nodeName,Z=J.nodeName,j,W;if(Q===Z)return!0;if(j=Q.charCodeAt(0),W=Z.charCodeAt(0),j<=90&&W>=97)return Q===Z.toUpperCase();else if(W<=90&&j>=97)return Z===Q.toUpperCase();else return!1}function vz(z,J){return!J||J===Rz?G.createElement(z):G.createElementNS(J,z)}function gz(z,J){var Q=z.firstChild;while(Q){var Z=Q.nextSibling;J.appendChild(Q),Q=Z}return J}function m(z,J,Q){if(z[Q]!==J[Q])if(z[Q]=J[Q],z[Q])z.setAttribute(Q,"");else z.removeAttribute(Q)}var Xz={OPTION:function(z,J){var Q=z.parentNode;if(Q){var Z=Q.nodeName.toUpperCase();if(Z==="OPTGROUP")Q=Q.parentNode,Z=Q&&Q.nodeName.toUpperCase();if(Z==="SELECT"&&!Q.hasAttribute("multiple")){if(z.hasAttribute("selected")&&!J.selected)z.setAttribute("selected","selected"),z.removeAttribute("selected");Q.selectedIndex=-1}}m(z,J,"selected")},INPUT:function(z,J){if(m(z,J,"checked"),m(z,J,"disabled"),z.value!==J.value)z.value=J.value;if(!J.hasAttribute("value"))z.removeAttribute("value")},TEXTAREA:function(z,J){var Q=J.value;if(z.value!==Q)z.value=Q;var Z=z.firstChild;if(Z){var j=Z.nodeValue;if(j==Q||!Q&&j==z.placeholder)return;Z.nodeValue=Q}},SELECT:function(z,J){if(!J.hasAttribute("multiple")){var Q=-1,Z=0,j=z.firstChild,W,B;while(j)if(B=j.nodeName&&j.nodeName.toUpperCase(),B==="OPTGROUP"){if(W=j,j=W.firstChild,!j)j=W.nextSibling,W=null}else{if(B==="OPTION"){if(j.hasAttribute("selected")){Q=Z;break}Z++}if(j=j.nextSibling,!j&&W)j=W.nextSibling,W=null}z.selectedIndex=Q}}},S=1,Hz=11,Pz=3,Gz=8;function w(){}function Cz(z){if(z)return z.getAttribute&&z.getAttribute("id")||z.id}function yz(z){return function(Q,Z,j){if(!j)j={};if(typeof Z==="string")if(Q.nodeName==="#document"||Q.nodeName==="HTML"){var W=Z;Z=G.createElement("html"),Z.innerHTML=W}else if(Q.nodeName==="BODY"){var B=Z;Z=G.createElement("html"),Z.innerHTML=B;var M=Z.querySelector("body");if(M)Z=M}else Z=Tz(Z);else if(Z.nodeType===Hz)Z=Z.firstElementChild;var V=j.getNodeKey||Cz,A=j.onBeforeNodeAdded||w,K=j.onNodeAdded||w,_z=j.onBeforeElUpdated||w,Az=j.onElUpdated||w,Lz=j.onBeforeNodeDiscarded||w,x=j.onNodeDiscarded||w,Dz=j.onBeforeElChildrenUpdated||w,Iz=j.skipFromChildren||w,d=j.addChild||function(q,Y){return q.appendChild(Y)},c=j.childrenOnly===!0,U=Object.create(null),k=[];function b(q){k.push(q)}function o(q,Y){if(q.nodeType===S){var H=q.firstChild;while(H){var $=void 0;if(Y&&($=V(H)))b($);else if(x(H),H.firstChild)o(H,Y);H=H.nextSibling}}}function F(q,Y,H){if(Lz(q)===!1)return;if(Y)Y.removeChild(q);x(q),o(q,H)}function N(q){if(q.nodeType===S||q.nodeType===Hz){var Y=q.firstChild;while(Y){var H=V(Y);if(H)U[H]=Y;N(Y),Y=Y.nextSibling}}}N(Q);function s(q){K(q);var Y=q.firstChild;while(Y){var H=Y.nextSibling,$=V(Y);if($){var X=U[$];if(X&&h(Y,X))Y.parentNode.replaceChild(X,Y),T(X,Y);else s(Y)}else s(Y);Y=H}}function wz(q,Y,H){while(Y){var $=Y.nextSibling;if(H=V(Y))b(H);else F(Y,q,!0);Y=$}}function T(q,Y,H){var $=V(Y);if($)delete U[$];if(!H){var X=_z(q,Y);if(X===!1)return;else if(X instanceof HTMLElement)q=X,N(q);if(z(q,Y),Az(q),Dz(q,Y)===!1)return}if(q.nodeName!=="TEXTAREA")Kz(q,Y);else Xz.TEXTAREA(q,Y)}function Kz(q,Y){var H=Iz(q,Y),$=Y.firstChild,X=q.firstChild,O,_,R,g,L;z:while($){g=$.nextSibling,O=V($);while(!H&&X){if(R=X.nextSibling,$.isSameNode&&$.isSameNode(X)){$=g,X=R;continue z}_=V(X);var C=X.nodeType,D=void 0;if(C===$.nodeType){if(C===S){if(O){if(O!==_)if(L=U[O])if(R===L)D=!1;else{if(q.insertBefore(L,X),_)b(_);else F(X,q,!0);X=L,_=V(X)}else D=!1}else if(_)D=!1;if(D=D!==!1&&h(X,$),D)T(X,$)}else if(C===Pz||C==Gz){if(D=!0,X.nodeValue!==$.nodeValue)X.nodeValue=$.nodeValue}}if(D){$=g,X=R;continue z}if(_)b(_);else F(X,q,!0);X=R}if(O&&(L=U[O])&&h(L,$)){if(!H)d(q,L);T(L,$)}else{var i=A($);if(i!==!1){if(i)$=i;if($.actualize)$=$.actualize(q.ownerDocument||G);d(q,$),s($)}}$=g,X=R}wz(q,X,_);var zz=Xz[q.nodeName];if(zz)zz(q,Y)}var P=Q,v=P.nodeType,e=Z.nodeType;if(!c){if(v===S)if(e===S){if(!h(Q,Z))x(Q),P=gz(Q,vz(Z.nodeName,Z.namespaceURI))}else P=Z;else if(v===Pz||v===Gz)if(e===v){if(P.nodeValue!==Z.nodeValue)P.nodeValue=Z.nodeValue;return P}else P=Z}if(P===Z)x(Q);else{if(Z.isSameNode&&Z.isSameNode(P))return;if(T(P,Z,c),k)for(var n=0,Uz=k.length;n<Uz;n++){var a=U[k[n]];if(a)F(a,a.parentNode,!1)}}if(!c&&P!==Q&&Q.parentNode){if(P.actualize)P=P.actualize(Q.ownerDocument||G);Q.parentNode.replaceChild(P,Q)}return P}}var Ez=yz(Oz),Bz=Ez;function p(z,J){let Q="";for(let Z=0;Z<z.length;Z++)if(Q+=z[Z],Z<J.length)Q+=hz(J[Z]);return Q}function hz(z){if(typeof z==="string")return z;if(Array.isArray(z))return z.map((J)=>p(J.s,J.d)).join("");if(z&&typeof z==="object"&&"s"in z&&"d"in z)return p(z.s,z.d);return""}function Vz(z,J){if(!J||!z)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(typeof j==="string")z[Z]=j;else if(Array.isArray(j))z[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)z[Z]=j;else if("d"in j){let W=z[Z];if(W&&typeof W==="object"){if(Array.isArray(W))Mz(W,j.d);else if("d"in W)l(W,j.d)}}}}}function l(z,J){if(!J||!z.d)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(typeof j==="string")z.d[Z]=j;else if(Array.isArray(j))z.d[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)z.d[Z]=j;else if("d"in j){let W=z.d[Z];if(W&&typeof W==="object"){if(Array.isArray(W))Mz(W,j.d);else if("d"in W)l(W,j.d)}}}}}function Mz(z,J){if(!J)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(j&&typeof j==="object"){if("s"in j&&"d"in j)z[Z]=j;else if("d"in j){if(z[Z]&&typeof z[Z]==="object"&&"d"in z[Z])l(z[Z],j.d)}}}}var r=new WeakMap;class f{container;module;token;id;loomSocket;initialized=!1;pendingEvents=[];statics=null;dynamics=null;loadingElements=new Map;constructor(z,J){this.container=z,this.module=z.dataset.lLive,this.token=z.dataset.lToken,this.loomSocket=J,this.id=J.allocateId(),J.register(this.id,(Q)=>this.handleMessage(Q)),J.onReconnect(()=>this.rejoin()),this.sendJoin(),this.attachEventListeners(),this.hideLoadingIndicators()}sendJoin(){this.loomSocket.send({type:"join",id:this.id,module:this.module,token:this.token}),this.initialized=!0;while(this.pendingEvents.length>0)this.sendEvent(this.pendingEvents.shift())}rejoin(){this.initialized=!1,this.statics=null,this.dynamics=null,this.sendJoin()}sendEvent(z){if(this.initialized)this.loomSocket.send(z);else this.pendingEvents.push(z)}handleMessage(z){switch(z.type){case"trees":this.statics=z.s,this.dynamics=z.d,this.clearLoadingStates();break;case"patch":if(this.clearLoadingStates(),this.statics&&this.dynamics){Vz(this.dynamics,z.d);let J=p(this.statics,this.dynamics);this.applyPatch(J)}break;case"error":this.clearLoadingStates(),console.error("[Loom] Server error:",z.error);break;default:console.warn("[Loom] Unknown message type:",z.type)}}applyPatch(z){let J=qz(),Q=document.createElement("div");Q.innerHTML=z,Bz(this.container,Q,{childrenOnly:!0,getNodeKey:Wz,onBeforeElUpdated:(Z,j)=>{if(Z!==this.container&&Z.hasAttribute("data-l-live"))return!1;if(Z===J.element&&J.isInput)j.value=Z.value;return!0}}),this.attachEventListeners(),this.hideLoadingIndicators(),Yz(this.container,J)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((J)=>{if(J.closest("[data-l-live]")!==this.container)return;this.attachElementListeners(J)})}attachElementListeners(z){if(z._loomAttached)return;z._loomAttached=!0;let J=Zz(z);Jz.forEach((Q)=>{let Z=z.dataset[`l${Q.charAt(0).toUpperCase()+Q.slice(1)}`];if(!Z)return;z.addEventListener(Q,(j)=>{this.handleEvent(j,Q,Z,J,z)})})}handleEvent(z,J,Q,Z,j){if(Z.prevent)z.preventDefault();if(Z.stop)z.stopPropagation();let W={type:"event",id:this.id,handler:Q,event:J,special_vars:jz(z)};if(Z.shouldDebounce)this.debouncedSend(j,W,Z.debounce);else{if(J==="click"||J==="submit")this.applyLoadingState(j);this.sendEvent(W)}}applyLoadingState(z){let J=z.hasAttribute("disabled");if(z.classList.add("l-loading"),!z.hasAttribute("l-no-disable"))z.setAttribute("disabled","");let Q=z.getAttribute("l-loading-text"),Z=null;if(Q!==null)Z=z.textContent,z.textContent=Q;let{shownIndicators:j,hiddenSiblings:W}=Q===null?this.toggleLoadingChildren(z):{shownIndicators:[],hiddenSiblings:[]},B=[],M=z.id;if(M)this.container.querySelectorAll(`[l-loading="${M}"], [data-l-loading="${M}"]`).forEach((V)=>{let A=V;A.classList.add("l-loading");let K=this.toggleLoadingChildren(A);B.push({element:A,...K})});this.loadingElements.set(z,{originalText:Z,wasDisabled:J,shownIndicators:j,hiddenSiblings:W,remoteTargets:B})}toggleLoadingChildren(z){let J=[],Q=[];for(let Z of Array.from(z.children))if(this.isLoadingIndicator(Z))Z.style.display="",J.push(Z);if(J.length>0){for(let Z of Array.from(z.children))if(!this.isLoadingIndicator(Z))Q.push({el:Z,originalDisplay:Z.style.display}),Z.style.display="none"}return{shownIndicators:J,hiddenSiblings:Q}}isLoadingIndicator(z){return z.getAttribute("l-loading")===""||z.getAttribute("data-l-loading")===""}clearLoadingStates(){this.loadingElements.forEach((z,J)=>{if(J.classList.remove("l-loading"),!z.wasDisabled)J.removeAttribute("disabled");if(z.originalText!==null)J.textContent=z.originalText;this.reverseChildToggle(z),z.remoteTargets.forEach((Q)=>{Q.element.classList.remove("l-loading"),this.reverseChildToggle(Q)})}),this.loadingElements.clear()}reverseChildToggle(z){z.shownIndicators.forEach((J)=>{J.style.display="none"}),z.hiddenSiblings.forEach(({el:J,originalDisplay:Q})=>{J.style.display=Q})}hideLoadingIndicators(){this.container.querySelectorAll('[l-loading=""], [data-l-loading=""]').forEach((z)=>{z.style.display="none"})}debouncedSend(z,J,Q){clearTimeout(r.get(z)),r.set(z,setTimeout(()=>{r.delete(z),this.sendEvent(J)},Q))}destroy(){this.loomSocket.unregister(this.id),this.initialized=!1}}var u=null,t=()=>{let z=document.querySelectorAll("[data-l-live]");if(z.length>0&&!u){let J=z[0].dataset.lWs||null;u=new y(J)}z.forEach((J)=>{if(J._loomInstance)return;J._loomInstance=new f(J,u)}),console.log(`[Loom] Initialized ${z.length} live component(s)`)};t();window.Loom={init:t,reinit:t,LoomLive:f,LoomSocket:y,CONFIG:I,get socket(){return u}};
