var L={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150},d=["click","input","change","submit","keydown","keyup","focus","blur"];var o=11;function Gz(z,Q){var J=Q.attributes,Z,j,X,V,x;if(Q.nodeType===o||z.nodeType===o)return;for(var B=J.length-1;B>=0;B--)if(Z=J[B],j=Z.name,X=Z.namespaceURI,V=Z.value,X){if(j=Z.localName||j,x=z.getAttributeNS(X,j),x!==V){if(Z.prefix==="xmlns")j=Z.name;z.setAttributeNS(X,j,V)}}else if(x=z.getAttribute(j),x!==V)z.setAttribute(j,V);var k=z.attributes;for(var U=k.length-1;U>=0;U--)if(Z=k[U],j=Z.name,X=Z.namespaceURI,X){if(j=Z.localName||j,!Q.hasAttributeNS(X,j))z.removeAttributeNS(X,j)}else if(!Q.hasAttribute(j))z.removeAttribute(j)}var C,Bz="http://www.w3.org/1999/xhtml",G=typeof document>"u"?void 0:document,Vz=!!G&&"content"in G.createElement("template"),Mz=!!G&&G.createRange&&"createContextualFragment"in G.createRange();function wz(z){var Q=G.createElement("template");return Q.innerHTML=z,Q.content.childNodes[0]}function _z(z){if(!C)C=G.createRange(),C.selectNode(G.body);var Q=C.createContextualFragment(z);return Q.childNodes[0]}function Dz(z){var Q=G.createElement("body");return Q.innerHTML=z,Q.childNodes[0]}function xz(z){if(z=z.trim(),Vz)return wz(z);else if(Mz)return _z(z);return Dz(z)}function f(z,Q){var J=z.nodeName,Z=Q.nodeName,j,X;if(J===Z)return!0;if(j=J.charCodeAt(0),X=Z.charCodeAt(0),j<=90&&X>=97)return J===Z.toUpperCase();else if(X<=90&&j>=97)return Z===J.toUpperCase();else return!1}function Lz(z,Q){return!Q||Q===Bz?G.createElement(z):G.createElementNS(Q,z)}function Sz(z,Q){var J=z.firstChild;while(J){var Z=J.nextSibling;Q.appendChild(J),J=Z}return Q}function n(z,Q,J){if(z[J]!==Q[J])if(z[J]=Q[J],z[J])z.setAttribute(J,"");else z.removeAttribute(J)}var e={OPTION:function(z,Q){var J=z.parentNode;if(J){var Z=J.nodeName.toUpperCase();if(Z==="OPTGROUP")J=J.parentNode,Z=J&&J.nodeName.toUpperCase();if(Z==="SELECT"&&!J.hasAttribute("multiple")){if(z.hasAttribute("selected")&&!Q.selected)z.setAttribute("selected","selected"),z.removeAttribute("selected");J.selectedIndex=-1}}n(z,Q,"selected")},INPUT:function(z,Q){if(n(z,Q,"checked"),n(z,Q,"disabled"),z.value!==Q.value)z.value=Q.value;if(!Q.hasAttribute("value"))z.removeAttribute("value")},TEXTAREA:function(z,Q){var J=Q.value;if(z.value!==J)z.value=J;var Z=z.firstChild;if(Z){var j=Z.nodeValue;if(j==J||!J&&j==z.placeholder)return;Z.nodeValue=J}},SELECT:function(z,Q){if(!Q.hasAttribute("multiple")){var J=-1,Z=0,j=z.firstChild,X,V;while(j)if(V=j.nodeName&&j.nodeName.toUpperCase(),V==="OPTGROUP"){if(X=j,j=X.firstChild,!j)j=X.nextSibling,X=null}else{if(V==="OPTION"){if(j.hasAttribute("selected")){J=Z;break}Z++}if(j=j.nextSibling,!j&&X)j=X.nextSibling,X=null}z.selectedIndex=J}}},O=1,zz=11,Jz=3,Qz=8;function D(){}function Iz(z){if(z)return z.getAttribute&&z.getAttribute("id")||z.id}function Az(z){return function(J,Z,j){if(!j)j={};if(typeof Z==="string")if(J.nodeName==="#document"||J.nodeName==="HTML"){var X=Z;Z=G.createElement("html"),Z.innerHTML=X}else if(J.nodeName==="BODY"){var V=Z;Z=G.createElement("html"),Z.innerHTML=V;var x=Z.querySelector("body");if(x)Z=x}else Z=xz(Z);else if(Z.nodeType===zz)Z=Z.firstElementChild;var B=j.getNodeKey||Iz,k=j.onBeforeNodeAdded||D,U=j.onNodeAdded||D,jz=j.onBeforeElUpdated||D,qz=j.onElUpdated||D,Yz=j.onBeforeNodeDiscarded||D,K=j.onNodeDiscarded||D,Wz=j.onBeforeElChildrenUpdated||D,$z=j.skipFromChildren||D,m=j.addChild||function(q,Y){return q.appendChild(Y)},E=j.childrenOnly===!0,S=Object.create(null),b=[];function R(q){b.push(q)}function l(q,Y){if(q.nodeType===O){var H=q.firstChild;while(H){var W=void 0;if(Y&&(W=B(H)))R(W);else if(K(H),H.firstChild)l(H,Y);H=H.nextSibling}}}function v(q,Y,H){if(Yz(q)===!1)return;if(Y)Y.removeChild(q);K(q),l(q,H)}function u(q){if(q.nodeType===O||q.nodeType===zz){var Y=q.firstChild;while(Y){var H=B(Y);if(H)S[H]=Y;u(Y),Y=Y.nextSibling}}}u(J);function p(q){U(q);var Y=q.firstChild;while(Y){var H=Y.nextSibling,W=B(Y);if(W){var $=S[W];if($&&f(Y,$))Y.parentNode.replaceChild($,Y),F($,Y);else p(Y)}else p(Y);Y=H}}function Xz(q,Y,H){while(Y){var W=Y.nextSibling;if(H=B(Y))R(H);else v(Y,q,!0);Y=W}}function F(q,Y,H){var W=B(Y);if(W)delete S[W];if(!H){var $=jz(q,Y);if($===!1)return;else if($ instanceof HTMLElement)q=$,u(q);if(z(q,Y),qz(q),Wz(q,Y)===!1)return}if(q.nodeName!=="TEXTAREA")Hz(q,Y);else e.TEXTAREA(q,Y)}function Hz(q,Y){var H=$z(q,Y),W=Y.firstChild,$=q.firstChild,I,M,A,g,w;z:while(W){g=W.nextSibling,I=B(W);while(!H&&$){if(A=$.nextSibling,W.isSameNode&&W.isSameNode($)){W=g,$=A;continue z}M=B($);var y=$.nodeType,_=void 0;if(y===W.nodeType){if(y===O){if(I){if(I!==M)if(w=S[I])if(A===w)_=!1;else{if(q.insertBefore(w,$),M)R(M);else v($,q,!0);$=w,M=B($)}else _=!1}else if(M)_=!1;if(_=_!==!1&&f($,W),_)F($,W)}else if(y===Jz||y==Qz){if(_=!0,$.nodeValue!==W.nodeValue)$.nodeValue=W.nodeValue}}if(_){W=g,$=A;continue z}if(M)R(M);else v($,q,!0);$=A}if(I&&(w=S[I])&&f(w,W)){if(!H)m(q,w);F(w,W)}else{var N=k(W);if(N!==!1){if(N)W=N;if(W.actualize)W=W.actualize(q.ownerDocument||G);m(q,W),p(W)}}W=g,$=A}Xz(q,$,M);var r=e[q.nodeName];if(r)r(q,Y)}var P=J,T=P.nodeType,t=Z.nodeType;if(!E){if(T===O)if(t===O){if(!f(J,Z))K(J),P=Sz(J,Lz(Z.nodeName,Z.namespaceURI))}else P=Z;else if(T===Jz||T===Qz)if(t===T){if(P.nodeValue!==Z.nodeValue)P.nodeValue=Z.nodeValue;return P}else P=Z}if(P===Z)K(J);else{if(Z.isSameNode&&Z.isSameNode(P))return;if(F(P,Z,E),b)for(var s=0,Pz=b.length;s<Pz;s++){var c=S[b[s]];if(c)v(c,c.parentNode,!1)}}if(!E&&P!==J&&J.parentNode){if(P.actualize)P=P.actualize(J.ownerDocument||G);J.parentNode.replaceChild(P,J)}return P}}var Uz=Az(Gz),Zz=Uz;var i=new WeakMap;class h{container;module;initialProps;wsUrlOverride;socket=null;reconnectAttempts=0;connected=!1;initialized=!1;pendingEvents=[];constructor(z){this.container=z,this.module=z.dataset.lLive,this.initialProps=z.dataset.lProps||"{}",this.wsUrlOverride=z.dataset.lWs||null,this.connect(),this.attachEventListeners()}connect(){let z;if(this.wsUrlOverride&&this.wsUrlOverride.startsWith("ws"))z=this.wsUrlOverride;else{let Q=window.location.protocol==="https:"?"wss:":"ws:",J=this.wsUrlOverride||L.wsPath;z=`${Q}//${window.location.host}${J}`}this.socket=new WebSocket(z),this.socket.onopen=()=>{console.log("[Loom] Connected:",this.module),this.connected=!0,this.reconnectAttempts=0,this.sendInit()},this.socket.onmessage=(Q)=>{this.handleMessage(JSON.parse(Q.data))},this.socket.onclose=()=>{console.log("[Loom] Disconnected:",this.module),this.connected=!1,this.initialized=!1,this.attemptReconnect()},this.socket.onerror=(Q)=>{console.error("[Loom] WebSocket error:",Q)}}sendInit(){this.socket.send(JSON.stringify({type:"init",module:this.module,props:this.initialProps})),this.initialized=!0;while(this.pendingEvents.length>0)this.send(this.pendingEvents.shift())}attemptReconnect(){if(this.reconnectAttempts>=L.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let z=L.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${z}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},z)}send(z){if(this.connected&&this.initialized&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(z));else this.pendingEvents.push(z)}handleMessage(z){switch(z.type){case"patch":this.applyPatch(z.html);break;case"redirect":window.location.href=z.url;break;case"error":console.error("[Loom] Server error:",z.error);break;default:console.warn("[Loom] Unknown message type:",z.type)}}saveFocus(){let z=document.activeElement,Q=z,J=!!z&&(z.tagName==="INPUT"||z.tagName==="TEXTAREA");return{element:z,isInput:J,selectionStart:Q?.selectionStart??null,selectionEnd:Q?.selectionEnd??null,handlerId:z?.dataset?.lInput||z?.dataset?.lChange||z?.id}}restoreFocus(z){if(!z.isInput||!z.handlerId)return;let Q=this.container.querySelector(`[data-l-input="${z.handlerId}"], [data-l-change="${z.handlerId}"], #${z.handlerId}`);if(!Q)return;if(Q.focus(),typeof z.selectionStart==="number"&&typeof z.selectionEnd==="number")try{Q.setSelectionRange(z.selectionStart,z.selectionEnd)}catch{}}applyPatch(z){let Q=this.saveFocus(),J=document.createElement("div");J.innerHTML=z,Zz(this.container,J,{childrenOnly:!0,getNodeKey:(Z)=>{if(Z.nodeType!==1)return null;let j=Z;return j.dataset?.lInput||j.dataset?.lClick||j.dataset?.lChange||j.dataset?.lSubmit||j.id||null},onBeforeElUpdated:(Z,j)=>{if(Z===Q.element&&Q.isInput)j.value=Z.value;return!0}}),this.attachEventListeners(),this.restoreFocus(Q)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((Q)=>this.attachElementListeners(Q))}attachElementListeners(z){if(z._loomAttached)return;z._loomAttached=!0;let Q=this.parseModifiers(z);d.forEach((J)=>{let Z=z.dataset[`l${J.charAt(0).toUpperCase()+J.slice(1)}`];if(!Z)return;z.addEventListener(J,(j)=>{this.handleEvent(j,J,Z,Q)})})}parseModifiers(z){return{prevent:z.dataset.lPrevent==="true",stop:z.dataset.lStop==="true",shouldDebounce:z.dataset.lDebounce!==void 0,debounce:parseInt(z.dataset.lDebounce||"")||L.defaultDebounce}}handleEvent(z,Q,J,Z){if(Z.prevent)z.preventDefault();if(Z.stop)z.stopPropagation();let j={handler:J,event:Q,special_vars:this.collectSpecialVars(z)};if(Z.shouldDebounce)this.debouncedSend(z.target,j,Z.debounce);else this.send(j)}collectSpecialVars(z){let Q={},J=z.target;if(J.value!==void 0)Q.value=J.value;if(J.type==="checkbox"||J.type==="radio")Q.checked=J.checked;if(z.key!==void 0)Q.key=z.key;return Q}debouncedSend(z,Q,J){clearTimeout(i.get(z)),i.set(z,setTimeout(()=>{i.delete(z),this.send(Q)},J))}destroy(){if(this.socket)this.socket.close(),this.socket=null;this.connected=!1,this.initialized=!1}}var a=()=>{let z=document.querySelectorAll("[data-l-live]");z.forEach((Q)=>{if(Q._loomInstance)return;Q._loomInstance=new h(Q)}),console.log(`[Loom] Initialized ${z.length} live component(s)`)};a();window.Loom={init:a,reinit:a,LoomLive:h,CONFIG:L};
