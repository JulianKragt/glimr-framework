var I={wsPath:"/loom/ws",reconnectInterval:1000,maxReconnectAttempts:10,defaultDebounce:150},Jz=["click","input","change","submit","keydown","keyup","focus","blur"];function Qz(z,J){if(z&&z.startsWith("ws"))return z;let Q=J.protocol==="https:"?"wss:":"ws:",Z=z||I.wsPath;return`${Q}//${J.host}${Z}`}function Zz(z){return{prevent:z.dataset.lPrevent==="true",stop:z.dataset.lStop==="true",shouldDebounce:z.dataset.lDebounce!==void 0,debounce:parseInt(z.dataset.lDebounce||"")||I.defaultDebounce}}function jz(z){let J={},Q=z.target;if(Q.value!==void 0)J.value=Q.value;if(Q.type==="checkbox"||Q.type==="radio")J.checked=Q.checked;if(z.key!==void 0)J.key=z.key;return J}function qz(){let z=document.activeElement,J=z,Q=!!z&&(z.tagName==="INPUT"||z.tagName==="TEXTAREA");return{element:z,isInput:Q,selectionStart:J?.selectionStart??null,selectionEnd:J?.selectionEnd??null,handlerId:z?.dataset?.lInput||z?.dataset?.lChange||z?.id}}function Yz(z,J){if(!J.isInput||!J.handlerId)return;let Q=z.querySelector(`[data-l-input="${J.handlerId}"], [data-l-change="${J.handlerId}"], #${J.handlerId}`);if(!Q)return;if(Q.focus(),typeof J.selectionStart==="number"&&typeof J.selectionEnd==="number")try{Q.setSelectionRange(J.selectionStart,J.selectionEnd)}catch{}}function Wz(z){if(z.nodeType!==1)return null;let J=z;return J.dataset?.lInput||J.dataset?.lClick||J.dataset?.lChange||J.dataset?.lSubmit||J.id||null}class y{socket=null;connected=!1;reconnectAttempts=0;nextId=0;handlers=new Map;reconnectCallbacks=[];pendingMessages=[];wsUrlOverride;constructor(z){this.wsUrlOverride=z??null,this.connect()}allocateId(){return`c${this.nextId++}`}register(z,J){this.handlers.set(z,J)}unregister(z){this.handlers.delete(z),this.send({type:"leave",id:z})}send(z){if(this.connected&&this.socket?.readyState===WebSocket.OPEN)this.socket.send(JSON.stringify(z));else this.pendingMessages.push(z)}onReconnect(z){this.reconnectCallbacks.push(z)}destroy(){for(let z of this.handlers.keys())this.send({type:"leave",id:z});if(this.handlers.clear(),this.reconnectCallbacks=[],this.socket)this.socket.onclose=null,this.socket.close(),this.socket=null;this.connected=!1}connect(){let z=Qz(this.wsUrlOverride,window.location);this.socket=new WebSocket(z),this.socket.onopen=()=>{if(console.log("[Loom] Socket connected"),this.connected=!0,this.reconnectAttempts=0,this.flushPending(),this.reconnectCallbacks.length>0)this.reconnectCallbacks.forEach((J)=>J())},this.socket.onmessage=(J)=>{this.routeMessage(JSON.parse(J.data))},this.socket.onclose=()=>{console.log("[Loom] Socket disconnected"),this.connected=!1,this.attemptReconnect()},this.socket.onerror=(J)=>{console.error("[Loom] Socket error:",J)}}flushPending(){while(this.pendingMessages.length>0){let z=this.pendingMessages.shift();this.socket.send(JSON.stringify(z))}}routeMessage(z){if(z.type==="redirect"){window.location.href=z.url;return}if(z.id){let J=this.handlers.get(z.id);if(J)J(z)}}attemptReconnect(){if(this.reconnectAttempts>=I.maxReconnectAttempts){console.error("[Loom] Max reconnect attempts reached");return}this.reconnectAttempts++;let z=I.reconnectInterval*Math.pow(2,this.reconnectAttempts-1);console.log(`[Loom] Reconnecting in ${z}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{if(!this.connected)this.connect()},z)}}var $z=11;function Oz(z,J){var Q=J.attributes,Z,j,q,H,D;if(J.nodeType===$z||z.nodeType===$z)return;for(var V=Q.length-1;V>=0;V--)if(Z=Q[V],j=Z.name,q=Z.namespaceURI,H=Z.value,q){if(j=Z.localName||j,D=z.getAttributeNS(q,j),D!==H){if(Z.prefix==="xmlns")j=Z.name;z.setAttributeNS(q,j,H)}}else if(D=z.getAttribute(j),D!==H)z.setAttribute(j,H);var R=z.attributes;for(var O=R.length-1;O>=0;O--)if(Z=R[O],j=Z.name,q=Z.namespaceURI,q){if(j=Z.localName||j,!J.hasAttributeNS(q,j))z.removeAttributeNS(q,j)}else if(!J.hasAttribute(j))z.removeAttribute(j)}var E,Sz="http://www.w3.org/1999/xhtml",B=typeof document>"u"?void 0:document,Rz=!!B&&"content"in B.createElement("template"),xz=!!B&&B.createRange&&"createContextualFragment"in B.createRange();function bz(z){var J=B.createElement("template");return J.innerHTML=z,J.content.childNodes[0]}function kz(z){if(!E)E=B.createRange(),E.selectNode(B.body);var J=E.createContextualFragment(z);return J.childNodes[0]}function Fz(z){var J=B.createElement("body");return J.innerHTML=z,J.childNodes[0]}function Tz(z){if(z=z.trim(),Rz)return bz(z);else if(xz)return kz(z);return Fz(z)}function h(z,J){var Q=z.nodeName,Z=J.nodeName,j,q;if(Q===Z)return!0;if(j=Q.charCodeAt(0),q=Z.charCodeAt(0),j<=90&&q>=97)return Q===Z.toUpperCase();else if(q<=90&&j>=97)return Z===Q.toUpperCase();else return!1}function vz(z,J){return!J||J===Sz?B.createElement(z):B.createElementNS(J,z)}function gz(z,J){var Q=z.firstChild;while(Q){var Z=Q.nextSibling;J.appendChild(Q),Q=Z}return J}function i(z,J,Q){if(z[Q]!==J[Q])if(z[Q]=J[Q],z[Q])z.setAttribute(Q,"");else z.removeAttribute(Q)}var Xz={OPTION:function(z,J){var Q=z.parentNode;if(Q){var Z=Q.nodeName.toUpperCase();if(Z==="OPTGROUP")Q=Q.parentNode,Z=Q&&Q.nodeName.toUpperCase();if(Z==="SELECT"&&!Q.hasAttribute("multiple")){if(z.hasAttribute("selected")&&!J.selected)z.setAttribute("selected","selected"),z.removeAttribute("selected");Q.selectedIndex=-1}}i(z,J,"selected")},INPUT:function(z,J){if(i(z,J,"checked"),i(z,J,"disabled"),z.value!==J.value)z.value=J.value;if(!J.hasAttribute("value"))z.removeAttribute("value")},TEXTAREA:function(z,J){var Q=J.value;if(z.value!==Q)z.value=Q;var Z=z.firstChild;if(Z){var j=Z.nodeValue;if(j==Q||!Q&&j==z.placeholder)return;Z.nodeValue=Q}},SELECT:function(z,J){if(!J.hasAttribute("multiple")){var Q=-1,Z=0,j=z.firstChild,q,H;while(j)if(H=j.nodeName&&j.nodeName.toUpperCase(),H==="OPTGROUP"){if(q=j,j=q.firstChild,!j)j=q.nextSibling,q=null}else{if(H==="OPTION"){if(j.hasAttribute("selected")){Q=Z;break}Z++}if(j=j.nextSibling,!j&&q)j=q.nextSibling,q=null}z.selectedIndex=Q}}},S=1,Hz=11,Pz=3,Gz=8;function L(){}function Cz(z){if(z)return z.getAttribute&&z.getAttribute("id")||z.id}function yz(z){return function(Q,Z,j){if(!j)j={};if(typeof Z==="string")if(Q.nodeName==="#document"||Q.nodeName==="HTML"){var q=Z;Z=B.createElement("html"),Z.innerHTML=q}else if(Q.nodeName==="BODY"){var H=Z;Z=B.createElement("html"),Z.innerHTML=H;var D=Z.querySelector("body");if(D)Z=D}else Z=Tz(Z);else if(Z.nodeType===Hz)Z=Z.firstElementChild;var V=j.getNodeKey||Cz,R=j.onBeforeNodeAdded||L,O=j.onNodeAdded||L,_z=j.onBeforeElUpdated||L,Az=j.onElUpdated||L,Iz=j.onBeforeNodeDiscarded||L,x=j.onNodeDiscarded||L,Lz=j.onBeforeElChildrenUpdated||L,Dz=j.skipFromChildren||L,d=j.addChild||function(Y,W){return Y.appendChild(W)},c=j.childrenOnly===!0,w=Object.create(null),b=[];function k(Y){b.push(Y)}function o(Y,W){if(Y.nodeType===S){var P=Y.firstChild;while(P){var $=void 0;if(W&&($=V(P)))k($);else if(x(P),P.firstChild)o(P,W);P=P.nextSibling}}}function F(Y,W,P){if(Iz(Y)===!1)return;if(W)W.removeChild(Y);x(Y),o(Y,P)}function N(Y){if(Y.nodeType===S||Y.nodeType===Hz){var W=Y.firstChild;while(W){var P=V(W);if(P)w[P]=W;N(W),W=W.nextSibling}}}N(Q);function s(Y){O(Y);var W=Y.firstChild;while(W){var P=W.nextSibling,$=V(W);if($){var X=w[$];if(X&&h(W,X))W.parentNode.replaceChild(X,W),T(X,W);else s(W)}else s(W);W=P}}function wz(Y,W,P){while(W){var $=W.nextSibling;if(P=V(W))k(P);else F(W,Y,!0);W=$}}function T(Y,W,P){var $=V(W);if($)delete w[$];if(!P){var X=_z(Y,W);if(X===!1)return;else if(X instanceof HTMLElement)Y=X,N(Y);if(z(Y,W),Az(Y),Lz(Y,W)===!1)return}if(Y.nodeName!=="TEXTAREA")Kz(Y,W);else Xz.TEXTAREA(Y,W)}function Kz(Y,W){var P=Dz(Y,W),$=W.firstChild,X=Y.firstChild,K,M,U,g,_;z:while($){g=$.nextSibling,K=V($);while(!P&&X){if(U=X.nextSibling,$.isSameNode&&$.isSameNode(X)){$=g,X=U;continue z}M=V(X);var C=X.nodeType,A=void 0;if(C===$.nodeType){if(C===S){if(K){if(K!==M)if(_=w[K])if(U===_)A=!1;else{if(Y.insertBefore(_,X),M)k(M);else F(X,Y,!0);X=_,M=V(X)}else A=!1}else if(M)A=!1;if(A=A!==!1&&h(X,$),A)T(X,$)}else if(C===Pz||C==Gz){if(A=!0,X.nodeValue!==$.nodeValue)X.nodeValue=$.nodeValue}}if(A){$=g,X=U;continue z}if(M)k(M);else F(X,Y,!0);X=U}if(K&&(_=w[K])&&h(_,$)){if(!P)d(Y,_);T(_,$)}else{var m=R($);if(m!==!1){if(m)$=m;if($.actualize)$=$.actualize(Y.ownerDocument||B);d(Y,$),s($)}}$=g,X=U}wz(Y,X,M);var zz=Xz[Y.nodeName];if(zz)zz(Y,W)}var G=Q,v=G.nodeType,e=Z.nodeType;if(!c){if(v===S)if(e===S){if(!h(Q,Z))x(Q),G=gz(Q,vz(Z.nodeName,Z.namespaceURI))}else G=Z;else if(v===Pz||v===Gz)if(e===v){if(G.nodeValue!==Z.nodeValue)G.nodeValue=Z.nodeValue;return G}else G=Z}if(G===Z)x(Q);else{if(Z.isSameNode&&Z.isSameNode(G))return;if(T(G,Z,c),b)for(var n=0,Uz=b.length;n<Uz;n++){var a=w[b[n]];if(a)F(a,a.parentNode,!1)}}if(!c&&G!==Q&&Q.parentNode){if(G.actualize)G=G.actualize(Q.ownerDocument||B);Q.parentNode.replaceChild(G,Q)}return G}}var Ez=yz(Oz),Bz=Ez;function p(z,J){let Q="";for(let Z=0;Z<z.length;Z++)if(Q+=z[Z],Z<J.length)Q+=hz(J[Z]);return Q}function hz(z){if(typeof z==="string")return z;if(Array.isArray(z))return z.map((J)=>p(J.s,J.d)).join("");if(z&&typeof z==="object"&&"s"in z&&"d"in z)return p(z.s,z.d);return""}function Vz(z,J){if(!J||!z)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(typeof j==="string")z[Z]=j;else if(Array.isArray(j))z[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)z[Z]=j;else if("d"in j){let q=z[Z];if(q&&typeof q==="object"){if(Array.isArray(q))Mz(q,j.d);else if("d"in q)l(q,j.d)}}}}}function l(z,J){if(!J||!z.d)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(typeof j==="string")z.d[Z]=j;else if(Array.isArray(j))z.d[Z]=j;else if(j&&typeof j==="object"){if("s"in j&&"d"in j)z.d[Z]=j;else if("d"in j){let q=z.d[Z];if(q&&typeof q==="object"){if(Array.isArray(q))Mz(q,j.d);else if("d"in q)l(q,j.d)}}}}}function Mz(z,J){if(!J)return;for(let Q of Object.keys(J)){let Z=parseInt(Q,10),j=J[Q];if(j&&typeof j==="object"){if("s"in j&&"d"in j)z[Z]=j;else if("d"in j){if(z[Z]&&typeof z[Z]==="object"&&"d"in z[Z])l(z[Z],j.d)}}}}var t=new WeakMap;class f{container;module;token;id;loomSocket;initialized=!1;pendingEvents=[];statics=null;dynamics=null;loadingElements=new Map;constructor(z,J){this.container=z,this.module=z.dataset.lLive,this.token=z.dataset.lToken,this.loomSocket=J,this.id=J.allocateId(),J.register(this.id,(Q)=>this.handleMessage(Q)),J.onReconnect(()=>this.rejoin()),this.sendJoin(),this.attachEventListeners(),this.hideLoadingIndicators()}sendJoin(){this.loomSocket.send({type:"join",id:this.id,module:this.module,token:this.token}),this.initialized=!0;while(this.pendingEvents.length>0)this.sendEvent(this.pendingEvents.shift())}rejoin(){this.initialized=!1,this.statics=null,this.dynamics=null,this.sendJoin()}sendEvent(z){if(this.initialized)this.loomSocket.send(z);else this.pendingEvents.push(z)}handleMessage(z){switch(z.type){case"trees":this.statics=z.s,this.dynamics=z.d,this.clearLoadingStates();break;case"patch":if(this.clearLoadingStates(),this.statics&&this.dynamics){Vz(this.dynamics,z.d);let J=p(this.statics,this.dynamics);this.applyPatch(J)}break;case"error":this.clearLoadingStates(),console.error("[Loom] Server error:",z.error);break;default:console.warn("[Loom] Unknown message type:",z.type)}}applyPatch(z){let J=qz(),Q=document.createElement("div");Q.innerHTML=z,Bz(this.container,Q,{childrenOnly:!0,getNodeKey:Wz,onBeforeElUpdated:(Z,j)=>{if(Z!==this.container&&Z.hasAttribute("data-l-live"))return!1;if(Z===J.element&&J.isInput)j.value=Z.value;return!0}}),this.attachEventListeners(),this.hideLoadingIndicators(),Yz(this.container,J)}attachEventListeners(){this.container.querySelectorAll("[data-l-click], [data-l-input], [data-l-change], [data-l-submit], [data-l-keydown], [data-l-keyup], [data-l-focus], [data-l-blur]").forEach((J)=>{if(J.closest("[data-l-live]")!==this.container)return;this.attachElementListeners(J)})}attachElementListeners(z){if(z._loomAttached)return;z._loomAttached=!0;let J=Zz(z);Jz.forEach((Q)=>{let Z=z.dataset[`l${Q.charAt(0).toUpperCase()+Q.slice(1)}`];if(!Z)return;z.addEventListener(Q,(j)=>{this.handleEvent(j,Q,Z,J,z)})})}handleEvent(z,J,Q,Z,j){if(Z.prevent)z.preventDefault();if(Z.stop)z.stopPropagation();let q={type:"event",id:this.id,handler:Q,event:J,special_vars:jz(z)};if(Z.shouldDebounce)this.debouncedSend(j,q,Z.debounce);else{if(J==="click"||J==="submit")this.applyLoadingState(j);this.sendEvent(q)}}applyLoadingState(z){let J=z.hasAttribute("disabled");if(z.classList.add("l-loading"),!z.hasAttribute("l-no-disable"))z.setAttribute("disabled","");let Q=z.getAttribute("l-loading-text"),Z=null;if(Q!==null)Z=z.textContent,z.textContent=Q;let j=[],q=[];if(Q===null){for(let H of Array.from(z.children))if(H.hasAttribute("l-loading")||H.hasAttribute("data-l-loading"))H.style.display="",j.push(H);if(j.length>0){for(let H of Array.from(z.children))if(!H.hasAttribute("l-loading")&&!H.hasAttribute("data-l-loading"))q.push({el:H,originalDisplay:H.style.display}),H.style.display="none"}}this.loadingElements.set(z,{originalText:Z,wasDisabled:J,shownIndicators:j,hiddenSiblings:q})}clearLoadingStates(){this.loadingElements.forEach((z,J)=>{if(J.classList.remove("l-loading"),!z.wasDisabled)J.removeAttribute("disabled");if(z.originalText!==null)J.textContent=z.originalText;z.shownIndicators.forEach((Q)=>{Q.style.display="none"}),z.hiddenSiblings.forEach(({el:Q,originalDisplay:Z})=>{Q.style.display=Z})}),this.loadingElements.clear()}hideLoadingIndicators(){this.container.querySelectorAll("[l-loading], [data-l-loading]").forEach((z)=>{z.style.display="none"})}debouncedSend(z,J,Q){clearTimeout(t.get(z)),t.set(z,setTimeout(()=>{t.delete(z),this.sendEvent(J)},Q))}destroy(){this.loomSocket.unregister(this.id),this.initialized=!1}}var u=null,r=()=>{let z=document.querySelectorAll("[data-l-live]");if(z.length>0&&!u){let J=z[0].dataset.lWs||null;u=new y(J)}z.forEach((J)=>{if(J._loomInstance)return;J._loomInstance=new f(J,u)}),console.log(`[Loom] Initialized ${z.length} live component(s)`)};r();window.Loom={init:r,reinit:r,LoomLive:f,LoomSocket:y,CONFIG:I,get socket(){return u}};
